<div class="container my-5">
  <!-- Header Section -->
  <div class="lectures-header">
    <div class="lectures-header-content">
      <h1>Quiz</h1>
      <p>Teste tes connaissances par cat√©gorie</p>
    </div>
  </div>

  <!-- Filter by difficulty -->
  <div class="filter_button_card">
    <aside class="menu-sticky">
    <%= link_to "Tous", quizzes_path, class: "filter_button #{params[:level].blank? ? 'active' : ''}" %>
    <% (1..5).each do |level| %>
      <%= link_to "Niveau #{level}", quizzes_path(level: level), class: "filter_button #{params[:level].to_i == level ? 'active' : ''}" %>
    <% end %>
    </aside>
  </div>

  <!-- Section Quizzes Publics -->
  <% if @public_quizzes.any? %>
    <div class="quizzes-section-container quizzes-section-public">
      <div class="quizzes-section-header">
        <h2 class="quizzes-section-title">
          <i class="fas fa-globe"></i> Quizzes Publics
        </h2>
        <p class="quizzes-section-subtitle">Accessibles √† tous les utilisateurs</p>
      </div>

      <% @public_quizzes.each do |category, quizzes| %>
        <% filtered_quizzes = params[:level].present? ? quizzes.select { |q| q.level == params[:level].to_i } : quizzes %>
        <% next if filtered_quizzes.empty? %>

        <div class="quizzes-category-block">
          <h3 class="quizzes-category-title">
            <span class="category-icon">üìÅ</span>
            <%= category.title %>
            <span class="category-count">(<%= filtered_quizzes.count %> quiz)</span>
          </h3>
          <div class="quizzes-grid">
            <% filtered_quizzes.each do |quiz| %>
              <%
                total = quiz.questions.count
                best_attempt = quiz.attempts.select { |a| a.user_id == current_user.id && a.done }.max_by(&:score)
                best_score = best_attempt&.score || 0
                percentage = total > 0 ? (best_score.to_f / total * 100).round : 0
              %>
              <%= link_to quiz_path(quiz), class: "quiz-card-link" do %>
                <div class="quiz-card quiz-card-public">
                  <div class="quiz-card-header">
                    <span class="quiz-card-category"><%= quiz.category.title %></span>
                    <span class="quiz-card-level">
                      <% quiz.level.times do %><i class="fas fa-star"></i><% end %>
                      <% (5 - quiz.level).times do %><i class="far fa-star"></i><% end %>
                    </span>
                  </div>
                  <h4 class="quiz-card-title"><%= quiz.title %></h4>
                  <div class="quiz-card-stats">
                    <span><i class="fas fa-question-circle"></i> <%= total %> questions</span>
                  </div>
                  <% if best_attempt %>
                    <div class="quiz-card-progress">
                      <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: <%= percentage %>%; background: <%= percentage == 100 ? '#28a745' : '#ffd700' %>;"></div>
                      </div>
                      <span class="progress-text">Meilleur: <%= best_score %>/<%= total %></span>
                    </div>
                  <% end %>
                  <div class="quiz-card-actions">
                    <span class="btn-quiz-play">
                      <i class="fas fa-play"></i> Jouer
                    </span>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Section Quizzes Partag√©s -->
  <% if @shared_quizzes.any? %>
    <div class="quizzes-section-container quizzes-section-shared">
      <div class="quizzes-section-header">
        <h2 class="quizzes-section-title">
          <i class="fas fa-share-alt"></i> Quizzes Partag√©s
        </h2>
        <p class="quizzes-section-subtitle">Cr√©√©s et partag√©s avec moi par la communaut√©</p>
      </div>

      <% @shared_quizzes.each do |category, quizzes| %>
        <% filtered_quizzes = params[:level].present? ? quizzes.select { |q| q.level == params[:level].to_i } : quizzes %>
        <% next if filtered_quizzes.empty? %>

        <div class="quizzes-category-block">
          <h3 class="quizzes-category-title">
            <span class="category-icon">üìÅ</span>
            <%= category.title %>
            <span class="category-count">(<%= filtered_quizzes.count %> quiz)</span>
          </h3>
          <div class="quizzes-grid">
            <% filtered_quizzes.each do |quiz| %>
              <%
                total = quiz.questions.count
                best_attempt = quiz.attempts.select { |a| a.user_id == current_user.id && a.done }.max_by(&:score)
                best_score = best_attempt&.score || 0
                percentage = total > 0 ? (best_score.to_f / total * 100).round : 0
                challenge = quiz.challenges.first
              %>
              <div class="quiz-card-wrapper">
                <div class="quiz-card quiz-card-shared">
                  <div class="quiz-card-header">
                    <span class="quiz-card-category"><%= quiz.category.title %></span>
                    <span class="quiz-card-level">
                      <% quiz.level.times do %><i class="fas fa-star"></i><% end %>
                      <% (5 - quiz.level).times do %><i class="far fa-star"></i><% end %>
                    </span>
                  </div>
                  <h4 class="quiz-card-title"><%= quiz.title %></h4>
                  <% if challenge&.user %>
                    <p class="quiz-card-from">
                      <i class="fas fa-user"></i> Cr√©√© par <%= challenge.user.display_name %>
                    </p>
                  <% end %>
                  <div class="quiz-card-stats">
                    <span><i class="fas fa-question-circle"></i> <%= total %> questions</span>
                    <% if challenge && challenge.invited_users.any? %>
                      <span data-bs-toggle="modal" data-bs-target="#sharedQuizModal<%= quiz.id %>" class="quiz-invited-link">
                        <i class="fas fa-users"></i> <%= challenge.invited_users.count %> invit√©(s)
                      </span>
                    <% end %>
                  </div>
                  <% if best_attempt %>
                    <div class="quiz-card-progress">
                      <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: <%= percentage %>%; background: <%= percentage == 100 ? '#28a745' : '#ffd700' %>;"></div>
                      </div>
                      <span class="progress-text">Meilleur: <%= best_score %>/<%= total %></span>
                    </div>
                  <% end %>
                  <div class="quiz-card-actions">
                    <%= link_to quiz_path(quiz), class: "btn-quiz-play" do %>
                      <i class="fas fa-play"></i> Jouer
                    <% end %>
                  </div>
                </div>
              </div>

              <% if challenge %>
                <!-- Modal invit√©s -->
                <div class="modal fade" id="sharedQuizModal<%= quiz.id %>" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                      <div class="modal-header modal-header-gradient">
                        <h5 class="modal-title">Invit√©s au quiz</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <% if challenge.invited_users.any? %>
                          <ul class="invited-users-list">
                            <% challenge.invited_users.each do |user| %>
                              <li><i class="fas fa-user"></i> <%= user.display_name %></li>
                            <% end %>
                          </ul>
                        <% else %>
                          <p class="text-muted text-center">Aucun invit√©</p>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- √âtat vide -->
  <% if @public_quizzes.empty? && @shared_quizzes.empty? %>
    <div class="quizzes-empty">
      <div class="quizzes-empty-icon">üß†</div>
      <h3>Aucun quiz disponible</h3>
      <p>Les quiz seront bient√¥t disponibles !</p>
    </div>
  <% end %>

  <!-- Back Button -->
  <div class="lectures-back-section">
    <%= link_to root_path, class: "btn-back-home" do %>
      <span>‚Üê</span>
      <span>Retour √† l'accueil</span>
    <% end %>
  </div>
</div>
