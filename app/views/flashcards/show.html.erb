<div class="container my-5">
  <div style="background: linear-gradient(135deg, #1351AA 0%, #1a66cc 100%); color: white; padding: 30px; border-radius: 25px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(19, 81, 170, 0.3); text-align: center;">
    <h2 style="margin: 0; font-weight: 700; font-size: 28px;">üìö Flashcard - <%= @flashcard.lecture.title %></h2>
  </div>

  <% questions = JSON.parse(@flashcard.content) %>

  <!-- Barre de progression -->
  <div style="background-color: white; padding: 20px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 3px 12px rgba(0,0,0,0.08);">
    <div class="d-flex justify-content-between mb-3">
      <span style="color: #1351AA; font-weight: 600;">Progression</span>
      <span id="progress-text" style="color: #666; font-weight: 500;">0 / <%= questions.count %> questions completees</span>
    </div>
    <div class="progress" style="height: 30px; border-radius: 20px; background-color: #E3E2DE;">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background: linear-gradient(135deg, #1351AA 0%, #1a66cc 100%); border-radius: 20px; font-weight: 600;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
  </div>

  <div id="quiz-container">
    <% questions.each_with_index do |q, index| %>
      <div id="question-<%= index %>" style="background: linear-gradient(to bottom, #ffffff 0%, #fafafa 100%); padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #E3E2DE;">
        <h5 style="color: #1351AA; font-weight: 600; margin-bottom: 15px;">Question <%= index + 1 %> / <%= questions.count %></h5>
        <p style="font-size: 16px; font-weight: 500; color: #333; margin-bottom: 20px; line-height: 1.5;"><%= q['question'] %></p>

        <div style="margin-bottom: 15px;">
          <textarea id="answer-<%= index %>" rows="3" placeholder="Tape ta reponse ici..." style="width: 100%; padding: 15px; border: 2px solid #E3E2DE; border-radius: 15px; font-size: 14px; outline: none; transition: all 0.3s;"></textarea>
        </div>

        <button onclick="showAnswer(<%= index %>)" style="padding: 12px 30px; background: linear-gradient(135deg, #1351AA 0%, #1a66cc 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 3px 10px rgba(19, 81, 170, 0.3); transition: all 0.3s;">
          üëÅÔ∏è Voir la reponse
        </button>

        <div id="correct-answer-<%= index %>" style="display: none; margin-top: 20px; padding: 20px; background-color: #E3E2DE; border-left: 5px solid #1351AA; border-radius: 15px;">
          <strong style="color: #1351AA; font-size: 15px;">‚úÖ Reponse correcte:</strong>
          <p style="margin: 10px 0 0 0; color: #333; line-height: 1.5;"><%= q['answer'] %></p>
        </div>
      </div>
    <% end %>
  </div>

  <div style="text-align: center; margin-top: 40px; padding: 30px; background-color: white; border-radius: 20px; box-shadow: 0 3px 12px rgba(0,0,0,0.08);">
    <%= link_to "‚Üê Retour a la lecture", lecture_path(@flashcard.lecture), style: "display: inline-block; padding: 12px 30px; background-color: #E3E2DE; color: #333; border-radius: 20px; text-decoration: none; font-weight: 600; font-size: 15px; margin-right: 15px; transition: all 0.3s;" %>
    <%= button_to "üóëÔ∏è Supprimer cette flashcard", flashcard_path(@flashcard), method: :delete, data: { confirm: "Es-tu sur de vouloir supprimer cette flashcard ?" }, style: "padding: 12px 30px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 15px; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);" %>
  </div>
</div>

<script>
  let completedQuestions = <%= @progress %>;
  const totalQuestions = <%= questions.count %>;
  const answeredQuestions = new Set();

  // Charger la progression initiale
  window.addEventListener('DOMContentLoaded', function() {
    if (completedQuestions > 0) {
      updateProgressDisplay();
    }
  });

  function showAnswer(index) {
    const answerDiv = document.getElementById('correct-answer-' + index);
    answerDiv.style.display = 'block';

    // Marquer la question comme completee seulement si pas deja comptee
    if (!answeredQuestions.has(index)) {
      answeredQuestions.add(index);
      completedQuestions++;
      updateProgressDisplay();
      saveProgress();
    }
  }

  function updateProgressDisplay() {
    const percentage = Math.round((completedQuestions / totalQuestions) * 100);
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = percentage + '%';
    progressText.textContent = completedQuestions + ' / ' + totalQuestions + ' questions completees';

    // Changer la couleur quand c'est termine
    if (completedQuestions === totalQuestions) {
      progressBar.classList.remove('progress-bar-animated');
      progressBar.classList.add('bg-success');
    }
  }

  function saveProgress() {
    fetch('<%= update_progress_flashcard_path(@flashcard) %>', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ progress: completedQuestions })
    });
  }
</script>
