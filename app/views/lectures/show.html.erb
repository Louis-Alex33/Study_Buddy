<div class="modal fade" id="exampleModalToggle" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div id="modal-content" class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel">Notes</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div id="modal-body" class="modal-body">
        <%= simple_form_for [@lecture, @note] do |f| %>
        <%= f.input :content %>
        <% end %>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal"> Open a new note </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel2">Note 2</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= simple_form_for [@lecture, @note] do |f| %>
        <%= f.input :content %>
        <% end %>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">1er note </button>
      </div>
    </div>
  </div>
</div>

<button id="toggle-note" class="btn-create-note" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">
   Cree une nouvelle note
</button>

<div class="container my-5">
  <!-- Header Section -->
  <div class="lecture-show-header">
    <div class="lecture-show-header-content">
      <span class="category-badge">
        <%= @lecture.category.title.upcase %>
      </span>
      <h1><%= @lecture.title %></h1>
      <p><%= sanitize(@lecture.resume, tags: %w[strong em br]) %></p>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column: Chat IA -->
    <div class="col-lg-5">
      <div class="assistant-ia-card">
        <div class="assistant-header">
          <div class="assistant-icon">üí¨</div>
          <div class="assistant-title">
            <h3>Assistant IA</h3>
            <p>Pose tes questions sur le cours</p>
          </div>
        </div>

        <div class="chat-messages-container">
          <% if @lecture.messages.any? %>
            <% @lecture.messages.order(:created_at).each do |message| %>
              <div class="chat-message <%= message.role == 'user' ? 'user-message' : 'assistant-message' %>">
                <div class="message-bubble">
                  <div class="message-role">
                    <%= message.role == 'user' ? 'TOI' : 'ASSISTANT IA' %>
                  </div>
                  <div class="message-content"><%= simple_format(message.content) %></div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="empty-chat">
              <div class="empty-icon">üí≠</div>
              <p>Commence la conversation avec l'assistant IA</p>
            </div>
          <% end %>
        </div>

        <%= form_with model: [:lecture, Message.new], url: lecture_messages_path(@lecture), local: true, class: "chat-input-form" do |f| %>
          <%= f.text_area :content, placeholder: "Tape ta question ici...", rows: 2 %>
          <%= f.submit "Envoyer", class: "submit-button" %>
        <% end %>
      </div>
    </div>

    <!-- Right Column: Flashcards & Quizz -->
    <div class="col-lg-7">
      <div class="row g-3">
        <!-- Flashcards Section (Top 50%) -->
        <div class="col-12">
          <div class="flashcards-card" style="height: calc(50vh - 2rem);">
            <div class="flashcards-header">
              <div class="flashcards-icon">üìö</div>
              <div class="flashcards-title">
                <h3>Flashcards</h3>
                <p>Revise tes connaissances</p>
              </div>
              <button type="button" data-bs-toggle="modal" data-bs-target="#generateFlashcardsModal" class="btn-generate-flashcards">
                ‚ú® Generer avec IA
              </button>
            </div>

            <% if @lecture.flashcards.any? %>
              <div class="flashcards-list" style="max-height: calc(100% - 80px); overflow-y: auto;">
                <% @lecture.flashcards.each do |flashcard| %>
                  <%
                    completion = current_user.flashcard_completions.find_by(flashcard: flashcard)
                    progress = completion ? completion.status.to_i : 0
                    questions = JSON.parse(flashcard.content)
                    total = questions.count
                    percentage = total > 0 ? (progress.to_f / total * 100).round : 0
                  %>
                  <div class="flashcard-item">
                    <div class="progress-bar" style="width: <%= percentage %>%;"></div>

                    <div class="flashcard-content">
                      <div class="flashcard-info">
                        <a href="<%= flashcard_path(flashcard) %>" class="flashcard-link">
                          Flashcard #<%= flashcard.id %>
                        </a>
                        <div class="flashcard-stats">
                          <span><%= total %> questions</span>
                          <span class="stat-separator">‚Ä¢</span>
                          <span><%= progress %> completees</span>
                        </div>
                      </div>

                      <div class="flashcard-actions">
                        <div class="progress-circle">
                          <svg width="70" height="70">
                            <circle cx="35" cy="35" r="30" fill="none" stroke="#E3E2DE" stroke-width="6"/>
                            <circle cx="35" cy="35" r="30" fill="none" stroke="<%= percentage == 100 ? '#28a745' : '#1351AA' %>" stroke-width="6" stroke-dasharray="<%= 2 * Math::PI * 30 %>" stroke-dashoffset="<%= 2 * Math::PI * 30 * (1 - percentage / 100.0) %>" stroke-linecap="round"/>
                          </svg>
                          <div class="progress-text" style="color: <%= percentage == 100 ? '#28a745' : '#1351AA' %>;">
                            <%= percentage %>%
                          </div>
                        </div>

                        <%= button_to flashcard_path(flashcard), method: :delete, data: { confirm: "Supprimer cette flashcard ?" }, class: "btn-delete-flashcard" do %>
                          üóëÔ∏è
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="empty-flashcards">
                <div class="empty-icon">üìö</div>
                <p>Aucune flashcard pour cette lecture</p>
                <button type="button" data-bs-toggle="modal" data-bs-target="#generateFlashcardsModal" class="btn-generate-flashcards-empty">
                  ‚ú® Generer des flashcards
                </button>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Quizz Section (Bottom 50%) -->
        <div class="col-12">
          <div class="flashcards-card" style="height: calc(50vh - 2rem);">
            <div class="flashcards-header">
              <div class="flashcards-icon">üß†</div>
              <div class="flashcards-title">
                <h3>Quizz</h3>
                <p>Valide tes connaissances</p>
              </div>
              <button type="button" data-bs-toggle="modal" data-bs-target="#generateQuizModal" class="btn-generate-flashcards">
                ‚ú® Generer avec IA
              </button>
            </div>

            <% if @lecture.quizzes.any? %>
              <div class="flashcards-list" style="max-height: calc(100% - 80px); overflow-y: auto;">
                <% @lecture.quizzes.each do |quiz| %>
                  <%
                    questions = JSON.parse(quiz.content)
                    total = questions.count
                    completed = quiz.status || 0
                    percentage = total > 0 ? (completed.to_f / total * 100).round : 0
                  %>
                  <div class="flashcard-item">
                    <div class="progress-bar" style="width: <%= percentage %>%;"></div>

                    <div class="flashcard-content">
                      <div class="flashcard-info">
                        <a href="<%= quiz_path(quiz) %>" class="flashcard-link">
                          Quiz de validation
                        </a>
                        <div class="flashcard-stats">
                          <span><%= total %> questions</span>
                          <span class="stat-separator">‚Ä¢</span>
                          <span><%= completed %> / <%= total %></span>
                        </div>
                      </div>

                      <div class="flashcard-actions">
                        <div class="progress-circle">
                          <svg width="70" height="70">
                            <circle cx="35" cy="35" r="30" fill="none" stroke="#E3E2DE" stroke-width="6"/>
                            <circle cx="35" cy="35" r="30" fill="none" stroke="<%= percentage == 100 ? '#28a745' : '#1351AA' %>" stroke-width="6" stroke-dasharray="<%= 2 * Math::PI * 30 %>" stroke-dashoffset="<%= 2 * Math::PI * 30 * (1 - percentage / 100.0) %>" stroke-linecap="round"/>
                          </svg>
                          <div class="progress-text" style="color: <%= percentage == 100 ? '#28a745' : '#1351AA' %>;">
                            <%= percentage %>%
                          </div>
                        </div>

                        <%= button_to quiz_path(quiz), method: :delete, data: { confirm: "Supprimer ce quiz ?" }, class: "btn-delete-flashcard" do %>
                          üóëÔ∏è
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="empty-flashcards">
                <div class="empty-icon">üß†</div>
                <p>Aucun quiz disponible</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions Footer -->
  <div class="lectures-back-section">
    <%= link_to root_path, class: "btn-back-home" do %>
      <span>‚Üê</span>
      <span>Retour a l'accueil</span>
    <% end %>
  </div>
</div>

<!-- Modal pour g√©n√©rer un quiz -->
<div class="modal fade modal-generate-flashcards" id="generateQuizModal" tabindex="-1" aria-labelledby="generateQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title">‚ú® Generer un quiz</h5>
          <p class="modal-subtitle">Avec l'intelligence artificielle</p>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="modal-icon">ü§ñ</div>
        <p>L'IA va generer automatiquement <strong>10 questions de validation</strong> basees sur le contenu de cette lecture.</p>
        <p class="modal-note">Ce quiz te permettra de valider tes connaissances sur cette le√ßon.</p>
      </div>
      <div class="modal-footer">
        <button type="button" data-bs-dismiss="modal" class="btn-modal-cancel">Annuler</button>
        <%= form_with url: lecture_quizzes_path(@lecture), method: :post, local: true, style: "display: inline;" do |f| %>
          <%= f.submit "Generer maintenant", class: "btn-modal-submit" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour g√©n√©rer les flashcards -->
<div class="modal fade modal-generate-flashcards" id="generateFlashcardsModal" tabindex="-1" aria-labelledby="generateFlashcardsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title">‚ú® Generer des flashcards</h5>
          <p class="modal-subtitle">Avec l'intelligence artificielle</p>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="modal-icon">ü§ñ</div>
        <p>L'IA va generer automatiquement <strong>10 questions</strong> basees sur le contenu de cette lecture.</p>
        <p class="modal-note">Ces flashcards te permettront de r√©viser r√©guli√®rement.</p>
      </div>
      <div class="modal-footer">
        <button type="button" data-bs-dismiss="modal" class="btn-modal-cancel">Annuler</button>
        <%= form_with url: lecture_flashcards_path(@lecture), method: :post, local: true, style: "display: inline;" do |f| %>
          <%= f.submit "Generer maintenant", class: "btn-modal-submit" %>
        <% end %>
      </div>
    </div>
  </div>
</div>
