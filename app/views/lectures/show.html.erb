
<button id="toggle-note"class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
  Mes Notes </button>
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">

  <div id="offcanvas-header" class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasExampleLabel">Mes Notes</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div id="offcanvas-body"class="offcanvas-body">
    <div id="notes-list">
     <% @lecture.notes.each do |note| %>
          <%= turbo_frame_tag dom_id(note) do %>
            <div class="d-flex justify-content-between">
              <div id="note-content" class="content">
                <%= note.content %>
              </div>
              <div  class="delete">
                <%= button_to note_path(note), method: :delete, data: { turbo_confirm: "Supprimer cette note ?" }, id:"btn-dlt-note" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="24" stroke-dashoffset="24" d="M12 20h5c0.5 0 1 -0.5 1 -1v-14M12 20h-5c-0.5 0 -1 -0.5 -1 -1v-14"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"></animate></path><path stroke-dasharray="20" stroke-dashoffset="20" d="M4 5h16"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.2s" values="20;0"></animate></path><path stroke-dasharray="8" stroke-dashoffset="8" d="M10 4h4M10 9v7M14 9v7"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="8;0"></animate></path></g></svg>


                <% end %>
              </div>
            </div>
          <% end %>
     <% end %>
    </div>

    <button id="btn-note"type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
      Nouvelle note
    </button>
  </div>
</div>

<!-- Modal pour nouvelle note (en dehors de l'offcanvas pour Ã©viter les conflits de z-index) -->
<div data-controller="handle-modal">
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" data-handle-modal-target="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= simple_form_for [@lecture, @note], data: { turbo_stream: true, handle_modal_target: "form", action: "turbo:submit-end->handle-modal#closeAndReset" } do |f| %>
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Nouvelle note</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-handle-modal-target="closeButton"></button>
        </div>
          <div class="modal-body">
              <%= f.input :content %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <%= f.button :submit, "Ajouter une note" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>



<div class="container my-5">
  <!-- Header Section -->
  <div class="lecture-show-header">
    <div class="lecture-show-header-content">
      <span class="category-badge">
        <%= @lecture.category.title.upcase %>
      </span>
      <h1><%= @lecture.title %></h1>
      <p><%= sanitize(@lecture.resume, tags: %w[strong em br]) %></p>
    </div>
  </div>

  <%= turbo_stream_from @lecture %>

  <div class="row g-4">
    <!-- Left Column: Chat IA -->
    <div class="col-lg-6">
      <div class="assistant-ia-card" data-controller="chat">
        <div class="assistant-header">
          <div class="assistant-icon">ðŸ’¬</div>
          <div class="assistant-title">
            <h3>Assistant IA</h3>
            <p>Pose tes questions sur le cours</p>
          </div>
        </div>

        <div id="chat-messages" class="chat-messages-container" data-chat-target="messages">
          <% if @lecture.messages.any? %>
            <% @lecture.messages.order(:created_at).each do |message| %>
              <%= render partial: "messages/message", locals: { message: message } %>
            <% end %>
          <% else %>
            <div id="empty-chat-placeholder" class="empty-chat">
              <div class="empty-icon">ðŸ’­</div>
              <p>Commence la conversation avec l'assistant IA</p>
            </div>
          <% end %>
        </div>

        <%= form_with model: [:lecture, Message.new], url: lecture_messages_path(@lecture), class: "chat-input-form", data: { turbo_stream: true, chat_target: "form", action: "turbo:submit-end->chat#resetForm" } do |f| %>
          <%= f.text_area :content, placeholder: "Tape ta question ici...", rows: 2, required: true, data: { chat_target: "input" } %>
          <%= f.submit "Envoyer", class: "submit-button" %>
        <% end %>
      </div>
    </div>

    <!-- Right Column: Flashcards & Quizz -->
    <div class="col-lg-6">
      <div class="row g-3">
        <!-- Flashcards Section (Top 50%) -->
        <div class="col-12">
          <div class="flashcards-card" style="height:100vh ;">
            <div class="flashcards-header">
              <div class="flashcards-icon">ðŸ“š</div>
              <div class="flashcards-title">
                <h3>Flashcards</h3>
                <p>Revise tes connaissances</p>
              </div>
              <button type="button" data-bs-toggle="modal" data-bs-target="#generateFlashcardsModal" class="btn-generate-flashcards">
                âœ¨ Generer avec IA
              </button>
            </div>

            <% if @lecture.flashcards.any? %>
              <div class="flashcards-list" style="max-height: calc(100% - 80px); overflow-y: auto;">
                <% @lecture.flashcards.each do |flashcard| %>
                  <%
                    completion = current_user.flashcard_completions.find_by(flashcard: flashcard)
                    progress = completion ? completion.status.to_i : 0
                    questions = JSON.parse(flashcard.content)
                    total = questions.count
                    percentage = total > 0 ? (progress.to_f / total * 100).round : 0
                  %>
                  <div class="flashcard-item">
                    <div class="progress-bar" style="width: <%= percentage %>%;"></div>

                    <div class="flashcard-content">
                      <div class="flashcard-info">
                        <a href="<%= flashcard_path(flashcard) %>" class="flashcard-link">
                          Flashcard #<%= flashcard.id %>
                        </a>
                        <div class="flashcard-stats">
                          <span><%= total %> questions</span>
                          <span class="stat-separator">â€¢</span>
                          <span><%= progress %> completees</span>
                        </div>
                      </div>

                      <div class="flashcard-actions">
                        <div class="progress-circle">
                          <svg width="70" height="70">
                            <circle cx="35" cy="35" r="30" fill="none" stroke="#E3E2DE" stroke-width="6"/>
                            <circle cx="35" cy="35" r="30" fill="none" stroke="<%= percentage == 100 ? '#28a745' : '#1351AA' %>" stroke-width="6" stroke-dasharray="<%= 2 * Math::PI * 30 %>" stroke-dashoffset="<%= 2 * Math::PI * 30 * (1 - percentage / 100.0) %>" stroke-linecap="round"/>
                          </svg>
                          <div class="progress-text" style="color: <%= percentage == 100 ? '#28a745' : '#1351AA' %>;">
                            <%= percentage %>%
                          </div>
                        </div>

                        <%= button_to flashcard_path(flashcard), method: :delete, data: { confirm: "Supprimer cette flashcard ?" }, class: "btn-delete-flashcard" do %>
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="24" stroke-dashoffset="24" d="M12 20h5c0.5 0 1 -0.5 1 -1v-14M12 20h-5c-0.5 0 -1 -0.5 -1 -1v-14"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"/></path><path stroke-dasharray="20" stroke-dashoffset="20" d="M4 5h16"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.2s" values="20;0"/></path><path stroke-dasharray="8" stroke-dashoffset="8" d="M10 4h4M10 9v7M14 9v7"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="8;0"/></path></g></svg>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="empty-flashcards">
                <div class="empty-icon">ðŸ“š</div>
                <p>Aucune flashcard pour le Cours</p>
              </div>
            <% end %>
          </div>
          <button type="button" data-bs-toggle="modal" data-bs-target="#generateFlashcardsModal" class="btn-generate-flashcards">
            âœ¨ Generer avec IA
          </button>
        </div>

<!-- Modal pour gÃ©nÃ©rer les flashcards -->
<div class="modal fade modal-generate-flashcards" id="generateFlashcardsModal" tabindex="-1" aria-labelledby="generateFlashcardsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title">âœ¨ Generer des flashcards</h5>
          <p class="modal-subtitle">Avec l'intelligence artificielle</p>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="modal-icon">ðŸ¤–</div>
        <p>L'IA va generer automatiquement <strong>10 questions</strong> basees sur le contenu de cette lecture.</p>
        <p class="modal-note">Ces flashcards te permettront de rÃ©viser rÃ©guliÃ¨rement.</p>
      </div>
      <div class="modal-footer" >
        <button type="button" data-bs-dismiss="modal" class="btn-modal-cancel">Annuler</button>
        <%= form_with url: lecture_flashcards_path(@lecture), data: { controller: "upload-loading", action: "submit->upload-loading#submit" },method: :post, local: true, style: "display: inline;" do |f| %>
          <%= f.submit "Generer maintenant", class: "btn-modal-submit" %>
        <% end %>
      </div>
    </div>
  </div>
</div>
